name: Sync to Hugging Face hub

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the repository with LFS support
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      # Step 2: Install Git LFS
      - name: Install Git LFS
        run: git lfs install

      # Step 3: Configure Git user
      - name: Configure Git user
        run: |
          git config --global user.email "your_email@example.com"
          git config --global user.name "Your Name"

      # Step 4: Track .nc files with Git LFS
      - name: Track .nc files with Git LFS
        run: |
          git lfs track "*.nc"
          git add .gitattributes
          git commit -m "Configure Git LFS for .nc files" || echo "No changes to .gitattributes"

      # Step 5: Migrate existing large files to Git LFS (if necessary)
      - name: Migrate existing large files to Git LFS
        run: |
          git lfs migrate import --include="www/data/ncs/tcdc.convcld.1981.nc" --force

      # Step 6: Add large files to Git
      - name: Add large files to Git
        run: |
          git add www/data/ncs/tcdc.convcld.1981.nc
          git commit -m "Add large .nc file with Git LFS" || echo "No changes to large files"

      # Step 7: Verify LFS tracking
      - name: Verify LFS tracking
        run: git lfs ls-files

      # Step 8: Push commits to Hugging Face hub
      - name: Push commits to Hugging Face hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git push https://alexdum:${HF_TOKEN}@huggingface.co/spaces/alexdum/roclihom main

      # Step 9: Push LFS objects to Hugging Face hub
      - name: Push LFS objects to Hugging Face hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git lfs push --all https://alexdum:${HF_TOKEN}@huggingface.co/spaces/alexdum/roclihom main
